# syntax=docker-registry.wikimedia.org/repos/releng/blubber/buildkit:v0.23.0
version: v4
base: docker-registry.wikimedia.org/python3-build-bookworm:0.2.0-20250831
runs:
  insecurely: true
  environment:
    PYTHONPATH: /opt/lib/python/site-packages:/opt/lib/venv/lib/python3.11/site-packages
variants:
  preparation:
    copies: [local]
  build:
    includes: [preparation]
    runs:
      environment:
        NLTK_DATA: '/home/somebody/nltk_data'
    builder:
      command: [ "PYTHONPATH=/opt/lib/python/site-packages", "python3", "-m", "nltk.downloader", "punkt" ]
    apt:
      packages:
       - python3-venv
       - python3-icu
       - python3-setuptools
       - default-libmysqlclient-dev
       - python3-dev
       - build-essential
       - python3-pip
       - curl
       - pkg-config
       - libicu-dev
       - libffi-dev
       - libssl-dev
       - git
    copies:
      - from: local
        source: .gitconfig
        destination: /home/runuser/.gitconfig
      - from: local
        source: .gitconfig
        destination: /home/somebody/.gitconfig
    python:
      version: python3
  test:
    runs:
      # Needed so that pytest can output coverage files to the /srv/app directory,
      # and also so that tox can generate its .tox directory here.
      insecurely: true
    includes: [build]
    entrypoint: [tox]
    apt:
      packages: [pkg-config, libicu-dev]
    python:
      requirements: [requirements.txt,requirements-test.txt]
  production-build:
    includes: [build]
    apt:
      packages: [python3,build-essential,mariadb-client,cmake]
  production:
    includes: [production-build]
    entrypoint: ["gunicorn", "app:app"]
    python:
      requirements: [requirements.txt]
  codehealth:
    base: docker-registry.wikimedia.org/releng/sonar-scanner:4.6.0.2311-s1
    includes: [preparation]
    runs:
      environment: { SONAR_API_KEY: "SONAR_API_KEY" }
      insecurely: true
    entrypoint:
      - /bin/bash
      - utils/run_sonar.sh
